!function(){"use strict";var e="undefined"!=typeof Float32Array?Float32Array:Array;function t(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var n=function(e,t,n,r,i,o,a){var s=1/(t-n),c=1/(r-i),u=1/(o-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+n)*s,e[13]=(i+r)*c,e[14]=(a+o)*u,e[15]=1,e};function r(){var t=new e(2);return e!=Float32Array&&(t[0]=0,t[1]=0),t}function i(t,n){var r=new e(2);return r[0]=t,r[1]=n,r}function o(e,t){return e[0]=t[0],e[1]=t[1],e}function a(e,t,n){return e[0]=t,e[1]=n,e}function s(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function c(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e}var u=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e};r();class d{constructor({device:e}){this.aspect=1,this.near=-100,this.far=100,this.zoom=100,this.position=r(),this.matrix=t(),this.matrixInverse=t(),this.device=e,this.buffer=e.createBuffer({size:this.matrix.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM})}update(){const{device:e,buffer:t,matrix:r,matrixInverse:i,aspect:o,near:a,far:s,zoom:c,position:u}=this,d=c*o*.5,h=.5*c;var l,p,f,g,m,v,w,b,x,y,E,M,z,A,U,B,I,P,F,R,L,T,C,G,S,_,k,q,O,V,W;n(r,u[0]-d,u[0]+d,u[1]-h,u[1]+h,a,s),l=i,f=(p=r)[0],g=p[1],m=p[2],v=p[3],w=p[4],b=p[5],x=p[6],y=p[7],E=p[8],M=p[9],z=p[10],A=p[11],U=p[12],B=p[13],I=p[14],P=p[15],(W=(F=f*b-g*w)*(V=z*P-A*I)-(R=f*x-m*w)*(O=M*P-A*B)+(L=f*y-v*w)*(q=M*I-z*B)+(T=g*x-m*b)*(k=E*P-A*U)-(C=g*y-v*b)*(_=E*I-z*U)+(G=m*y-v*x)*(S=E*B-M*U))&&(W=1/W,l[0]=(b*V-x*O+y*q)*W,l[1]=(m*O-g*V-v*q)*W,l[2]=(B*G-I*C+P*T)*W,l[3]=(z*C-M*G-A*T)*W,l[4]=(x*k-w*V-y*_)*W,l[5]=(f*V-m*k+v*_)*W,l[6]=(I*L-U*G-P*R)*W,l[7]=(E*G-z*L+A*R)*W,l[8]=(w*O-b*k+y*S)*W,l[9]=(g*k-f*O-v*S)*W,l[10]=(U*C-B*L+P*F)*W,l[11]=(M*L-E*C-A*F)*W,l[12]=(b*_-w*q-x*S)*W,l[13]=(f*q-g*_+m*S)*W,l[14]=(B*R-U*T-I*F)*W,l[15]=(E*T-M*R+z*F)*W),e.queue.writeBuffer(t,0,r)}}var h=[[[0,3,5,6,7,8,11],[0,2,4,6,7,8,9],[0,3,4,5,7,9,10],[0,2,4,5,6,10,11]],[[1,2,4,9,10],[1,3,5,10,11],[1,2,6,8,11],[1,3,7,8,9]],[[1,2,4,9,10],[0,2,4,6,7,8,9],[1,2,6,8,11],[0,2,4,5,6,10,11]],[[0,3,5,6,7,8,11],[1,3,5,10,11],[0,3,4,5,7,9,10],[1,3,7,8,9]],[[0,3,5,6,7,8,11],[0,2,4,6,7,8,9],[1,2,6,8,11],[0,2,4,5,6,10,11]],[[0,3,5,6,7,8,11],[0,2,4,6,7,8,9],[0,3,4,5,7,9,10],[1,3,7,8,9]],[[1,2,4,9,10],[0,2,4,6,7,8,9],[0,3,4,5,7,9,10],[0,2,4,5,6,10,11]],[[0,3,5,6,7,8,11],[1,3,5,10,11],[0,3,4,5,7,9,10],[0,2,4,5,6,10,11]],[[1,2,4,9,10],[1,3,5,10,11],[0,3,4,5,7,9,10],[0,2,4,5,6,10,11]],[[0,3,5,6,7,8,11],[1,3,5,10,11],[1,2,6,8,11],[0,2,4,5,6,10,11]],[[0,3,5,6,7,8,11],[0,2,4,6,7,8,9],[1,2,6,8,11],[1,3,7,8,9]],[[1,2,4,9,10],[0,2,4,6,7,8,9],[0,3,4,5,7,9,10],[1,3,7,8,9]]];const l=Array.from({length:h.length},((e,t)=>t)),p=[[0,1],[-1,0],[0,-1],[1,0]];class f{constructor({device:e,neighbors:t,position:n,size:r}){this.edges=[new Uint32Array(r[0]),new Uint32Array(r[1]),new Uint32Array(r[0]),new Uint32Array(r[1])],this.cells=e.createBuffer({mappedAtCreation:!0,size:r[0]*r[1]*Uint32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.VERTEX}),(({neighbors:e,output:t,size:n})=>{const r=Array.from({length:n[0]*n[1]},(()=>l.slice()));let i=!1;const o=(e,t,o)=>p.forEach(((s,c)=>{const u=t+s[0],d=o+s[1];if(u<0||u>=n[0]||d<0||d>=n[1])return;const l=d*n[0]+u,p=r[l];let f=!1;for(let t=0,n=p.length;t<n;t++){const r=p[t];-1===h[r][c].findIndex((t=>e.includes(t)))&&(i&&!i.has(l)&&i.set(l,p.slice()),p.splice(t,1),t--,n--,f=!0)}if(0===p.length)throw new Error("FAIL");f&&a(l)})),a=e=>o(r[e],Math.floor(e%n[0]),Math.floor(e/n[0]));e.forEach(((e,t)=>e&&e.edges[t].forEach(((e,r)=>{let i,a;switch(t){case 0:i=r,a=-1;break;case 1:i=n[0],a=r;break;case 2:i=r,a=n[1];break;case 3:i=-1,a=r}try{o([e],i,a)}catch(e){throw new Error("Failed to propagate neighbor state")}})))),i=new Map;const s=Array.from({length:r.length},((e,t)=>t));for(;s.length;){const e=s.splice(Math.floor(Math.random()*s.length),1)[0],t=r[e];if(1!==t.length)for(;t.length;){const n=t.splice(Math.floor(Math.random()*t.length),1)[0];r[e]=[n];try{a(e);break}catch(e){i.forEach(((e,t)=>{r[t]=e}))}finally{i.clear()}}}r.forEach((([e],n)=>{t.cells[n]=e})),r.length=0;for(let e=0;e<n[0];e++)t.edges[0][e]=t.cells[(n[1]-1)*n[0]+e],t.edges[2][e]=t.cells[e];for(let e=0;e<n[1];e++)t.edges[1][e]=t.cells[e*n[0]],t.edges[3][e]=t.cells[e*n[0]+(n[0]-1)]})({neighbors:t,output:{cells:new Uint32Array(this.cells.getMappedRange()),edges:this.edges},size:r}),this.cells.unmap(),this.position=e.createBuffer({mappedAtCreation:!0,size:2*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM}),new Float32Array(this.position.getMappedRange()).set([n[0]*r[0],n[1]*r[1]+r[1]]),this.position.unmap()}}var g=e=>{const t=e.createTexture({dimension:"2d",format:"rgba8unorm",size:[16,16,12],usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING}),n=new Image;return n.crossOrigin="anonymous",n.addEventListener("load",(()=>{const r=document.createElement("canvas"),i=r.getContext("2d");r.width=16,r.height=192,i.drawImage(n,0,0);const o=i.getImageData(0,0,r.width,r.height);e.queue.writeTexture({texture:t},o.data.buffer,{bytesPerRow:64,rowsPerImage:16},[16,16,12])}),!1),n.src="fe0fba6944314168.png",t.createView()};const m=({stride:e})=>`\n@group(0) @binding(0) var<uniform> camera : mat4x4<f32>;\n@group(0) @binding(1) var atlas : texture_2d_array<f32>;\n@group(0) @binding(2) var atlasSampler : sampler;\n@group(1) @binding(0) var<uniform> chunk : vec2<f32>;\n\nstruct VertexInput {\n  @builtin(vertex_index) index : u32,\n  @builtin(instance_index) instance: u32,\n  @location(0) texture : u32,\n}\n\nstruct VertexOutput {\n  @builtin(position) position : vec4<f32>,\n  @location(0) @interpolate(flat) texture : u32,\n  @location(1) uv : vec2<f32>,\n}\n\nconst quad = array<vec4<f32>, 6>(\n  vec4<f32>(0, 0, 0, 1), vec4<f32>(1, 0, 1, 1), vec4<f32>(0, 1, 0, 0),\n  vec4<f32>(0, 1, 0, 0), vec4<f32>(1, 0, 1, 1), vec4<f32>(1, 1, 1, 0)\n);\n\n@vertex\nfn vertex(vertex : VertexInput) -> VertexOutput {\n  var out : VertexOutput;\n  out.position = camera * vec4<f32>(vec2<f32>(f32(vertex.instance % ${e}), f32(vertex.instance / ${e}) * -1 - 1) + chunk + quad[vertex.index].xy, 0, 1);\n  out.texture = vertex.texture;\n  out.uv = quad[vertex.index].zw;\n  return out;\n}\n\nstruct FragmentInput {\n  @location(0) @interpolate(flat) texture : u32,\n  @location(1) uv : vec2<f32>,\n}\n\n@fragment\nfn fragment(fragment : FragmentInput) -> @location(0) vec4<f32> {\n  return textureSample(atlas, atlasSampler, fragment.uv, i32(fragment.texture));\n}\n`;class v{constructor({renderer:{camera:e,device:t,format:n},chunks:r,size:i}){this.chunks=r,this.count=i[0]*i[1],this.device=t;const o=t.createShaderModule({code:m({stride:i[0]})});this.pipeline=t.createRenderPipeline({layout:"auto",vertex:{buffers:[{arrayStride:1*Float32Array.BYTES_PER_ELEMENT,stepMode:"instance",attributes:[{shaderLocation:0,offset:0,format:"uint32"}]}],entryPoint:"vertex",module:o},fragment:{entryPoint:"fragment",module:o,targets:[{format:n}]},primitive:{topology:"triangle-list"}}),this.bindings=t.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:e.buffer}},{binding:1,resource:g(t)},{binding:2,resource:t.createSampler({magFilter:"linear",minFilter:"linear"})}]})}render(e){const{bindings:t,chunks:n,count:r,device:i,pipeline:o}=this;e.setPipeline(o),e.setBindGroup(0,t),n.forEach((t=>{t.bindings||(t.bindings=i.createBindGroup({layout:o.getBindGroupLayout(1),entries:[{binding:0,resource:{buffer:t.position}}]})),e.setBindGroup(1,t.bindings),e.setVertexBuffer(0,t.cells),e.draw(6,r)}))}}class w{constructor({camera:e,target:n}){this.buttons={primary:!1,secondary:!1,zoomin:!1,zoomout:!1},this.camera=e,this.cursor=i(0,0),this.pointer=i(0,0),this.panning={enabled:!1,initial:r(),matrix:t(),origin:r()},window.addEventListener("blur",this.onBlur.bind(this),!1),n.addEventListener("mousedown",this.onMouseDown.bind(this),!1),window.addEventListener("mousemove",this.onMouseMove.bind(this),!1),window.addEventListener("mouseup",this.onMouseUp.bind(this),!1),window.addEventListener("wheel",this.onMouseWheel.bind(this),!1),w.setCursor("grab")}onBlur(){const{buttons:e}=this;e.primary=e.secondary=e.zoomin=e.zoomout=!1,w.setCursor("grab")}onMouseDown({button:e}){const{buttons:t}=this;switch(e){case 0:t.primary=!0;break;case 2:t.secondary=!0}}onMouseMove({clientX:e,clientY:t}){const{pointer:n}=this;a(n,e/window.innerWidth*2-1,-t/window.innerHeight*2+1)}onMouseUp({button:e}){const{buttons:t}=this;switch(e){case 0:t.primary=!1;break;case 2:t.secondary=!1}}onMouseWheel({deltaY:e}){const{buttons:t}=this;t.zoomin=e<0,t.zoomout=e>0}static setCursor(e){document.body.style.cursor=e}update(){const{buttons:e,camera:t,cursor:n,panning:r,pointer:i}=this;if(r.enabled)return e.primary?(o(n,i),c(n,n,r.matrix),u(t.position,r.initial,n),s(t.position,t.position,r.origin),t.update(),!0):(r.enabled=!1,void w.setCursor("grab"));var a,d;if(e.primary&&(r.enabled=!0,w.setCursor("grabbing"),o(r.origin,t.position),a=r.matrix,d=t.matrixInverse,a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],a[6]=d[6],a[7]=d[7],a[8]=d[8],a[9]=d[9],a[10]=d[10],a[11]=d[11],a[12]=d[12],a[13]=d[13],a[14]=d[14],a[15]=d[15],o(r.initial,i),c(r.initial,r.initial,r.matrix)),e.zoomin||e.zoomout){const r=e.zoomin?-1:1;return e.zoomin=e.zoomout=!1,o(n,i),c(n,n,t.matrixInverse),u(n,n,t.position),s(t.position,t.position,n),t.zoom+=4*r,t.zoom=Math.min(Math.max(t.zoom,30),160),t.update(),o(n,i),c(n,n,t.matrixInverse),u(n,n,t.position),u(t.position,t.position,n),t.update(),!0}}}class b{constructor({adapter:e,camera:t,device:n,pixelRatio:r=window.devicePixelRatio||1}){this.camera=t,this.device=n,this.format=navigator.gpu.getPreferredCanvasFormat(e),this.canvas=document.createElement("canvas"),this.canvas.width=Math.floor(window.innerWidth*r),this.canvas.height=Math.floor(window.innerHeight*r),this.context=this.canvas.getContext("webgpu"),this.context.configure({alphaMode:"opaque",device:n,format:this.format}),this.descriptor={colorAttachments:[{clearValue:{r:1,g:1,b:1,a:1},loadOp:"clear",storeOp:"store"}]},this.pixelRatio=r,this.scene=[],this.textures=new Map}render(e){const{context:t,descriptor:n,scene:r}=this;n.colorAttachments[0].view=t.getCurrentTexture().createView();const i=e.beginRenderPass(n);r.forEach((e=>e.render(i))),i.end()}setSize(e,t){const{camera:n,canvas:r,pixelRatio:i}=this;r.width=Math.floor(e*i),r.height=Math.floor(t*i),r.style.width=`${e}px`,r.style.height=`${t}px`,n.aspect=e/t,n.update()}}(async()=>{if(!navigator.gpu)throw new Error("WebGPU support");const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("WebGPU adapter");const t=await e.requestDevice();return{adapter:e,device:t}})().then((({adapter:e,device:t})=>{const n=new d({device:t}),o=new b({adapter:e,camera:n,device:t,pixelRatio:Math.max(window.devicePixelRatio||1,1.5)});document.getElementById("renderer").appendChild(o.canvas),o.setSize(window.innerWidth,window.innerHeight);const s={data:new Map,render:[],size:i(32,32)},u=new v({renderer:o,chunks:s.render,size:s.size});o.scene.push(u);const h=new w({camera:n,target:o.canvas}),l=()=>{requestAnimationFrame(l),h.update()&&x();const e=t.createCommandEncoder();o.render(e),t.queue.submit([e.finish()])};requestAnimationFrame(l);const p=[[0,1],[1,0],[0,-1],[-1,0]],g=e=>{const n=`${e[0]}:${e[1]}`;let r=s.data.get(n);if(!r){const i=p.map((t=>s.data.get(`${e[0]+t[0]}:${e[1]+t[1]}`)));r=new f({device:t,neighbors:i,position:e,size:s.size}),s.data.set(n,r)}return r},m=[r(),r()],x=()=>{m.forEach(((e,t)=>{var r,i,o;a(e,0===t?-1:1,0===t?-1:1),c(e,e,n.matrixInverse),r=e,i=e,o=s.size,r[0]=i[0]/o[0],r[1]=i[1]/o[1],function(e,t){e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1])}(e,e)})),s.render.length=0;for(let e=m[0][1];e<=m[1][1];e++)for(let t=m[0][0];t<=m[1][0];t++)s.render.push(g(i(t,e)))};x(),window.addEventListener("resize",(()=>{o.setSize(window.innerWidth,window.innerHeight),x()}),!1)})).catch((e=>{console.error(e),document.getElementById("support").classList.add("enabled")})).finally((()=>document.getElementById("loading").classList.remove("enabled")))}();
